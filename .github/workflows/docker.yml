name: CI

on:
  pull_request:
  push:

env:
  AWS_ACCESS_KEY_ID: ${{ secrets.APT_REPO_AWS_ACCESS_KEY_ID }}
  AWS_SECRET_ACCESS_KEY: ${{ secrets.APT_REPO_AWS_SECRET_ACCESS_KEY }}
  AWS_BUCKET_NAME: stol-apt-repository

jobs:
  build-package:
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/usdot-fhwa-stol/carma-builds:cmake_shared
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Install dependencies
        run: |
          apt update
          apt -y install debhelper devscripts equivs ruby
          gem install deb-s3
          ./install_dependencies.sh
      - name: Build
        run: |
          ./build.sh

      - name: Upload .deb files
        run: |
          deb-s3 upload --codename develop --bucket ${{ env.AWS_BUCKET_NAME }} build/_packages/*.deb
